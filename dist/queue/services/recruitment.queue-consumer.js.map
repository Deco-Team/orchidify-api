{"version":3,"file":"recruitment.queue-consumer.js","sourceRoot":"/","sources":["queue/services/recruitment.queue-consumer.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA,0CAAyC;AAEzC,wDAAgD;AAChD,iFAA+D;AAC/D,2CAAsD;AACtD,2CAAuC;AACvC,oDAA8D;AAE9D,yCAAyC;AACzC,wFAA+E;AAGxE,IAAM,wBAAwB,gCAA9B,MAAM,wBAAyB,SAAQ,mBAAU;IAEtD,YAEE,kBAAwD;QAExD,KAAK,EAAE,CAAA;QAFU,uBAAkB,GAAlB,kBAAkB,CAAqB;QAHzC,cAAS,GAAG,IAAI,8BAAS,CAAC,0BAAwB,CAAC,IAAI,CAAC,CAAA;IAMzE,CAAC;IAED,KAAK,CAAC,OAAO,CAAC,GAAa;QACzB,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,+BAA+B,GAAG,CAAC,EAAE,EAAE,CAAC,CAAA;QAC3D,IAAI,CAAC;YACH,QAAQ,GAAG,CAAC,IAAI,EAAE,CAAC;gBACjB,KAAK,kBAAO,CAAC,sBAAsB,CAAC,CAAC,CAAC;oBACpC,OAAO,MAAM,IAAI,CAAC,qBAAqB,CAAC,GAAG,CAAC,CAAA;gBAC9C,CAAC;gBACD,QAAQ;YACV,CAAC;YACD,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,sCAAsC,CAAC,CAAA;QAC5D,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,KAAK,CAAC,CAAA;YAC3B,MAAM,KAAK,CAAA;QACb,CAAC;IACH,CAAC;IAED,KAAK,CAAC,qBAAqB,CAAC,GAAQ;QAClC,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,+BAA+B,GAAG,CAAC,EAAE,UAAU,GAAG,CAAC,IAAI,UAAU,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,CAAA;QAGjH,MAAM,EAAE,SAAS,EAAE,GAAG,GAAG,CAAC,IAAI,CAAA;QAC9B,MAAM,SAAS,GAAG,MAAM,CAAC,EAAE,CAAC,oBAAW,CAAC,CAAC,aAAa,CAAC,MAAM,CAAC,EAAE,CAAC,SAAS,EAAE,oBAAW,CAAC,CAAC,CAAA;QACzF,IAAI,CAAC,SAAS;YAAE,OAAO,6BAA6B,CAAA;QAEpD,IAAI,CAAC;YACH,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,sDAAsD,GAAG,CAAC,EAAE,EAAE,CAAC,CAAA;YAClF,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC,CAAA;YAClE,IAAI,CAAC,WAAW;gBAAE,OAAO,cAAM,CAAC,qBAAqB,CAAC,KAAK,CAAA;YAE3D,MAAM,IAAI,CAAC,kBAAkB,CAAC,yBAAyB,CAAC,GAAG,CAAC,EAAE,EAAE,EAAE,IAAI,EAAE,QAAoB,EAAE,CAAC,CAAA;YAE/F,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,oDAAoD,GAAG,CAAC,EAAE,EAAE,CAAC,CAAA;YAChF,OAAO,IAAI,CAAA;QACb,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,SAAS,CAAC,KAAK,CAClB,qCAAqC,GAAG,CAAC,EAAE,UAAU,GAAG,CAAC,IAAI,UAAU,IAAI,CAAC,SAAS,CACnF,GAAG,CAAC,IAAI,CACT,WAAW,KAAK,EAAE,CACpB,CAAA;YACD,OAAO,KAAK,CAAA;QACd,CAAC;IACH,CAAC;CACF,CAAA;AAnDY,4DAAwB;mCAAxB,wBAAwB;IADpC,IAAA,kBAAS,EAAC,oBAAS,CAAC,WAAW,CAAC;IAI5B,WAAA,IAAA,eAAM,EAAC,yCAAmB,CAAC,CAAA;;GAHnB,wBAAwB,CAmDpC","sourcesContent":["import * as moment from 'moment-timezone'\r\nimport { UserRole } from '@common/contracts/constant'\r\nimport { Errors } from '@common/contracts/error'\r\nimport { AppLogger } from '@common/services/app-logger.service'\r\nimport { Processor, WorkerHost } from '@nestjs/bullmq'\r\nimport { Inject } from '@nestjs/common'\r\nimport { JobName, QueueName } from '@queue/contracts/constant'\r\nimport { Job } from 'bullmq'\r\nimport { VN_TIMEZONE } from '@src/config'\r\nimport { IRecruitmentService } from '@recruitment/services/recruitment.service'\r\n\r\n@Processor(QueueName.RECRUITMENT)\r\nexport class RecruitmentQueueConsumer extends WorkerHost {\r\n  private readonly appLogger = new AppLogger(RecruitmentQueueConsumer.name)\r\n  constructor(\r\n    @Inject(IRecruitmentService)\r\n    private readonly recruitmentService: IRecruitmentService\r\n  ) {\r\n    super()\r\n  }\r\n\r\n  async process(job: Job<any>): Promise<any> {\r\n    this.appLogger.log(`[process] Processing job id=${job.id}`)\r\n    try {\r\n      switch (job.name) {\r\n        case JobName.RecruitmentAutoExpired: {\r\n          return await this.updateStatusToExpired(job)\r\n        }\r\n        default:\r\n      }\r\n      this.appLogger.log('[process] Job processed successfully')\r\n    } catch (error) {\r\n      this.appLogger.error(error)\r\n      throw error // Re-queue job in case of failure\r\n    }\r\n  }\r\n\r\n  async updateStatusToExpired(job: Job) {\r\n    this.appLogger.debug(`[updateStatusToExpired]: id=${job.id}, name=${job.name}, data=${JSON.stringify(job.data)}`)\r\n\r\n    // check expired time\r\n    const { expiredAt } = job.data\r\n    const isExpired = moment.tz(VN_TIMEZONE).isSameOrAfter(moment.tz(expiredAt, VN_TIMEZONE))\r\n    if (!isExpired) return 'Recruitment not expired yet'\r\n\r\n    try {\r\n      this.appLogger.log(`[updateStatusToExpired]: Start update status... id=${job.id}`)\r\n      const recruitment = await this.recruitmentService.findById(job.id)\r\n      if (!recruitment) return Errors.RECRUITMENT_NOT_FOUND.error\r\n\r\n      await this.recruitmentService.expiredRecruitmentProcess(job.id, { role: 'SYSTEM' as UserRole })\r\n\r\n      this.appLogger.log(`[updateStatusToExpired]: End update status... id=${job.id}`)\r\n      return true\r\n    } catch (error) {\r\n      this.appLogger.error(\r\n        `[updateStatusToExpired]: error id=${job.id}, name=${job.name}, data=${JSON.stringify(\r\n          job.data\r\n        )}, error=${error}`\r\n      )\r\n      return false\r\n    }\r\n  }\r\n}\r\n"]}
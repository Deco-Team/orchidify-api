{"version":3,"file":"management.report.controller.js","sourceRoot":"/","sources":["report/controllers/management.report.controller.ts"],"names":[],"mappings":"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","sourcesContent":["import { Controller, Get, Inject, Query, UseGuards } from '@nestjs/common'\r\nimport { ApiBadRequestResponse, ApiBearerAuth, ApiOkResponse, ApiOperation, ApiTags } from '@nestjs/swagger'\r\nimport * as _ from 'lodash'\r\n\r\nimport { ErrorResponse } from '@common/contracts/dto'\r\nimport { IReportService } from '@report/services/report.service'\r\nimport {\r\n  QueryReportClassByMonthDto,\r\n  ReportClassByStatusListDataResponse,\r\n  ReportTotalSummaryListDataResponse,\r\n  ReportUserByMonthListDataResponse\r\n} from '@report/dto/view-report.dto'\r\nimport { JwtAuthGuard } from '@auth/guards/jwt-auth.guard'\r\nimport { RolesGuard } from '@auth/guards/roles.guard'\r\nimport { ClassStatus, UserRole } from '@common/contracts/constant'\r\nimport { Roles } from '@auth/decorators/roles.decorator'\r\nimport { ReportType } from '@report/contracts/constant'\r\n\r\n@ApiTags('Report')\r\n@ApiBearerAuth()\r\n@ApiBadRequestResponse({ type: ErrorResponse })\r\n@UseGuards(JwtAuthGuard.ACCESS_TOKEN, RolesGuard)\r\n@Controller('management')\r\nexport class ManagementReportController {\r\n  constructor(\r\n    @Inject(IReportService)\r\n    private readonly reportService: IReportService\r\n  ) {}\r\n\r\n  @ApiOperation({\r\n    summary: `[${UserRole.STAFF}] View Report Data Total Summary`\r\n  })\r\n  @ApiBearerAuth()\r\n  @ApiOkResponse({ type: ReportTotalSummaryListDataResponse })\r\n  @Roles(UserRole.STAFF)\r\n  @Get('total-summary')\r\n  async viewReportTotalSummary() {\r\n    const reports = await this.reportService.findMany({\r\n      type: {\r\n        $in: [ReportType.CourseSum, ReportType.LearnerSum, ReportType.InstructorSum, ReportType.CourseComboSum]\r\n      }\r\n    })\r\n    return { docs: reports }\r\n  }\r\n\r\n  @ApiOperation({\r\n    summary: `[${UserRole.STAFF}] View Report User Data By Month`\r\n  })\r\n  @ApiBearerAuth()\r\n  @ApiOkResponse({ type: ReportUserByMonthListDataResponse })\r\n  @Roles(UserRole.STAFF)\r\n  @Get('user-by-month')\r\n  async viewReportUserDataByMonth(@Query() queryReportClassByMonthDto: QueryReportClassByMonthDto) {\r\n    const { year = 2024 } = queryReportClassByMonthDto\r\n    const [learnerReport, instructorReport] = await this.reportService.findMany({\r\n      type: {\r\n        $in: [ReportType.LearnerSumByMonth, ReportType.InstructorSumByMonth]\r\n      },\r\n      'data.year': year\r\n    })\r\n    const docs = []\r\n    if (learnerReport && instructorReport) {\r\n      for (let month = 1; month <= 12; month++) {\r\n        const learner = _.get(learnerReport.data, `${month}`) || { quantity: 0 }\r\n        const instructor = _.get(instructorReport.data, `${month}`) || { quantity: 0 }\r\n        docs.push({\r\n          learner,\r\n          instructor\r\n        })\r\n      }\r\n    }\r\n    return { docs }\r\n  }\r\n\r\n  @ApiOperation({\r\n    summary: `[${UserRole.STAFF}] View Report Class Data By Status`\r\n  })\r\n  @ApiBearerAuth()\r\n  @ApiOkResponse({ type: ReportClassByStatusListDataResponse })\r\n  @Roles(UserRole.STAFF)\r\n  @Get('class-by-status')\r\n  async viewReportClassDataByStatus() {\r\n    const report = await this.reportService.findOne({ type: ReportType.ClassSum })\r\n    return {\r\n      quantity: report.data.quantity,\r\n      docs: Object.keys(_.omit(report.data, ['quantity'])).map((statusKey) => ({\r\n        status: ClassStatus[statusKey],\r\n        quantity: report.data[statusKey].quantity\r\n      }))\r\n    }\r\n  }\r\n}\r\n"]}
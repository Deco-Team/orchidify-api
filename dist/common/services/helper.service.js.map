{"version":3,"file":"helper.service.js","sourceRoot":"/","sources":["common/services/helper.service.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,2CAA2C;AAC3C,+CAAmD;AACnD,mCAAmC;AACnC,iCAAgC;AAChC,uCAAoD;AACpD,oDAAoD;AACpD,yCAAyC;AACzC,0CAAyC;AAGlC,IAAM,aAAa,GAAnB,MAAM,aAAa;IACxB,YAAgC,UAAuC;QAAtB,eAAU,GAAV,UAAU,CAAY;QAmBvE,yBAAoB,GAAG,CAAC,MAAM,GAAG,CAAC,EAAE,UAAU,GAAG,YAAY,EAAE,EAAE;YAC/D,IAAI,YAAY,GAAG,EAAE,CAAA;YACrB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;gBAChC,MAAM,WAAW,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,UAAU,CAAC,MAAM,CAAC,CAAA;gBACjE,YAAY,IAAI,UAAU,CAAC,MAAM,CAAC,WAAW,CAAC,CAAA;YAChD,CAAC;YACD,OAAO,YAAY,CAAA;QACrB,CAAC,CAAA;IA1ByE,CAAC;IAE3E,KAAK,CAAC,4BAA4B,CAChC,EAAwE,EACxE,IAA0B;QAE1B,IAAI,MAAW,CAAA;QACf,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,YAAY,EAAE,CAAA;QACpD,MAAM,OAAO,CAAC,eAAe,CAAC,KAAK,IAAI,EAAE;YACvC,MAAM,GAAG,MAAM,EAAE,CAAC,OAAO,EAAE,IAAI,CAAC,CAAA;QAClC,CAAC,CAAC,CAAA;QACF,OAAO,MAAM,CAAA;IACf,CAAC;IAED,eAAe,CAAC,OAAe,EAAE,GAAW;QAC1C,MAAM,SAAS,GAAG,IAAA,mBAAU,EAAC,QAAQ,EAAE,GAAG,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAA;QACzE,OAAO,SAAS,CAAA;IAClB,CAAC;IAWD,KAAK,CAAC,YAAY,CAAC,QAAgB;QACjC,MAAM,IAAI,GAAG,MAAM,MAAM,CAAC,OAAO,EAAE,CAAA;QACnC,MAAM,IAAI,GAAG,MAAM,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAA;QAC9C,OAAO,IAAI,CAAA;IACb,CAAC;IAED,KAAK,CAAC,eAAe,CAAC,QAAgB,EAAE,IAAY;QAClD,OAAO,MAAM,MAAM,CAAC,OAAO,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAA;IAC7C,CAAC;IAED,gBAAgB,CAAC,QAAmB;QAClC,IAAI,CAAC,QAAQ,IAAI,QAAQ,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YACvC,OAAO,KAAK,CAAA;QACd,CAAC;QAED,MAAM,kBAAkB,GAAG;YACzB,CAAC,kBAAO,CAAC,MAAM,EAAE,kBAAO,CAAC,QAAQ,CAAC;YAClC,CAAC,kBAAO,CAAC,OAAO,EAAE,kBAAO,CAAC,MAAM,CAAC;YACjC,CAAC,kBAAO,CAAC,SAAS,EAAE,kBAAO,CAAC,QAAQ,CAAC;SACtC,CAAA;QAED,OAAO,kBAAkB,CAAC,IAAI,CAAC,CAAC,KAAK,EAAE,EAAE,CAAC,QAAQ,CAAC,CAAC,CAAC,KAAK,KAAK,CAAC,CAAC,CAAC,IAAI,QAAQ,CAAC,CAAC,CAAC,KAAK,KAAK,CAAC,CAAC,CAAC,CAAC,CAAA;IACjG,CAAC;IAED,mBAAmB,CAAC,EAClB,IAAI,EACJ,SAAS,EACT,KAAK,EACL,IAAI,EAML;QACC,MAAM,UAAU,GAAG,SAAS,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC,CAAA;QACvE,OAAO;YACL,IAAI;YACJ,SAAS;YACT,KAAK;YACL,IAAI;YACJ,UAAU;YACV,aAAa,EAAE,IAAI;YACnB,WAAW,EAAE,IAAI,GAAG,UAAU;YAC9B,WAAW,EAAE,IAAI,GAAG,UAAU;YAC9B,QAAQ,EAAE,IAAI,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,GAAG,CAAC;YAC1C,QAAQ,EAAE,IAAI,GAAG,UAAU,CAAC,CAAC,CAAC,IAAI,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI;SAC9C,CAAA;IACH,CAAC;IAED,yBAAyB,CAAC,IAAU;QAClC,MAAM,QAAQ,GAAG,MAAM,CAAC,EAAE,CAAC,IAAI,EAAE,oBAAW,CAAC,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC,EAAE,CAAC,oBAAW,CAAC,EAAE,cAAc,CAAC,CAAA;QAC5F,OAAO,QAAQ,GAAG,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAA;IACpC,CAAC;CACF,CAAA;AAnFY,sCAAa;wBAAb,aAAa;IADzB,IAAA,mBAAU,GAAE;IAEE,WAAA,IAAA,2BAAgB,GAAE,CAAA;qCAA8B,qBAAU;GAD5D,aAAa,CAmFzB","sourcesContent":["import { Injectable } from '@nestjs/common'\r\nimport { InjectConnection } from '@nestjs/mongoose'\r\nimport { createHmac } from 'crypto'\r\nimport * as bcrypt from 'bcrypt'\r\nimport { Connection, ClientSession } from 'mongoose'\r\nimport { Weekday } from '@common/contracts/constant'\r\nimport { VN_TIMEZONE } from '@src/config'\r\nimport * as moment from 'moment-timezone'\r\n\r\n@Injectable()\r\nexport class HelperService {\r\n  constructor(@InjectConnection() private readonly connection: Connection) {}\r\n\r\n  async executeCommandsInTransaction(\r\n    fn: (session: ClientSession, data?: Record<string, any>) => Promise<any>,\r\n    data?: Record<string, any>\r\n  ): Promise<any> {\r\n    let result: any\r\n    const session = await this.connection.startSession()\r\n    await session.withTransaction(async () => {\r\n      result = await fn(session, data)\r\n    })\r\n    return result\r\n  }\r\n\r\n  createSignature(rawData: string, key: string) {\r\n    const signature = createHmac('sha256', key).update(rawData).digest('hex')\r\n    return signature\r\n  }\r\n\r\n  generateRandomString = (length = 6, characters = '0123456789') => {\r\n    let randomString = ''\r\n    for (let i = 0; i < length; i++) {\r\n      const randomIndex = Math.floor(Math.random() * characters.length)\r\n      randomString += characters.charAt(randomIndex)\r\n    }\r\n    return randomString\r\n  }\r\n\r\n  async hashPassword(password: string): Promise<string> {\r\n    const salt = await bcrypt.genSalt()\r\n    const hash = await bcrypt.hash(password, salt)\r\n    return hash\r\n  }\r\n\r\n  async comparePassword(password: string, hash: string): Promise<boolean> {\r\n    return await bcrypt.compare(password, hash)\r\n  }\r\n\r\n  validateWeekdays(weekdays: Weekday[]): boolean {\r\n    if (!weekdays || weekdays.length !== 2) {\r\n      return false\r\n    }\r\n\r\n    const validWeekdayTuples = [\r\n      [Weekday.MONDAY, Weekday.THURSDAY],\r\n      [Weekday.TUESDAY, Weekday.FRIDAY],\r\n      [Weekday.WEDNESDAY, Weekday.SATURDAY]\r\n    ]\r\n\r\n    return validWeekdayTuples.some((tuple) => weekdays[0] === tuple[0] && weekdays[1] === tuple[1])\r\n  }\r\n\r\n  convertDataToPaging({\r\n    docs,\r\n    totalDocs,\r\n    limit,\r\n    page\r\n  }: {\r\n    docs: Array<any>\r\n    totalDocs: number\r\n    limit: number\r\n    page: number\r\n  }) {\r\n    const totalPages = totalDocs < limit ? 1 : Math.ceil(totalDocs / limit)\r\n    return {\r\n      docs,\r\n      totalDocs,\r\n      limit,\r\n      page,\r\n      totalPages,\r\n      pagingCounter: null,\r\n      hasPrevPage: page > totalPages,\r\n      hasNextPage: page < totalPages,\r\n      prevPage: page - 1 === 0 ? null : page - 1,\r\n      nextPage: page < totalPages ? page + 1 : null\r\n    }\r\n  }\r\n\r\n  getDiffTimeByMilliseconds(date: Date): number {\r\n    const diffTime = moment.tz(date, VN_TIMEZONE).diff(moment().tz(VN_TIMEZONE), 'milliseconds')\r\n    return diffTime > 0 ? diffTime : 0\r\n  }\r\n}\r\n"]}
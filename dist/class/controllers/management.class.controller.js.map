{"version":3,"file":"management.class.controller.js","sourceRoot":"/","sources":["class/controllers/management.class.controller.ts"],"names":[],"mappings":"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","sourcesContent":["import { Controller, Get, UseGuards, Inject, Query, Param, Req, Patch, Body } from '@nestjs/common'\r\nimport { ApiBadRequestResponse, ApiBearerAuth, ApiOkResponse, ApiOperation, ApiQuery, ApiTags } from '@nestjs/swagger'\r\nimport * as _ from 'lodash'\r\n\r\nimport { ErrorResponse, PaginationQuery, SuccessDataResponse, SuccessResponse } from '@common/contracts/dto'\r\nimport { Roles } from '@auth/decorators/roles.decorator'\r\nimport { ClassStatus, SlotNumber, UserRole } from '@common/contracts/constant'\r\nimport { JwtAuthGuard } from '@auth/guards/jwt-auth.guard'\r\nimport { RolesGuard } from '@auth/guards/roles.guard'\r\nimport { AppException } from '@common/exceptions/app.exception'\r\nimport { Errors } from '@common/contracts/error'\r\nimport { ApiErrorResponse } from '@common/decorators/api-response.decorator'\r\nimport { IClassService } from '@class/services/class.service'\r\nimport { Pagination, PaginationParams } from '@common/decorators/pagination.decorator'\r\nimport {\r\n  GardenManagerViewClassDetailDataResponse,\r\n  QueryClassDto,\r\n  StaffViewClassDetailDataResponse,\r\n  StaffViewClassListDataResponse\r\n} from '@class/dto/view-class.dto'\r\nimport { CLASS_DETAIL_PROJECTION, GARDEN_MANAGER_VIEW_CLASS_DETAIL_PROJECTION } from '@class/contracts/constant'\r\nimport { IAssignmentService } from '@class/services/assignment.service'\r\nimport { ViewAssignmentDetailDataResponse } from '@class/dto/view-assignment.dto'\r\nimport { ISessionService } from '@class/services/session.service'\r\nimport { ViewSessionDetailDataResponse } from '@class/dto/view-session.dto'\r\nimport { Types } from 'mongoose'\r\nimport { ILearnerClassService } from '@class/services/learner-class.service'\r\nimport { VN_TIMEZONE } from '@src/config'\r\nimport * as moment from 'moment-timezone'\r\nimport { CancelClassDto } from '@class/dto/cancel-class.dto'\r\n\r\n@ApiTags('Class - Management')\r\n@ApiBearerAuth()\r\n@ApiBadRequestResponse({ type: ErrorResponse })\r\n@UseGuards(JwtAuthGuard.ACCESS_TOKEN, RolesGuard)\r\n@Controller('management')\r\nexport class ManagementClassController {\r\n  constructor(\r\n    @Inject(IClassService)\r\n    private readonly classService: IClassService,\r\n    @Inject(ISessionService)\r\n    private readonly sessionService: ISessionService,\r\n    @Inject(IAssignmentService)\r\n    private readonly assignmentService: IAssignmentService,\r\n    @Inject(ILearnerClassService)\r\n    private readonly learnerClassService: ILearnerClassService\r\n  ) {}\r\n\r\n  @ApiOperation({\r\n    summary: `[${UserRole.STAFF}] View Class List`\r\n  })\r\n  @ApiQuery({ type: PaginationQuery })\r\n  @ApiOkResponse({ type: StaffViewClassListDataResponse })\r\n  @Roles(UserRole.STAFF)\r\n  @Get()\r\n  async list(@Pagination() pagination: PaginationParams, @Query() queryClassDto: QueryClassDto) {\r\n    return await this.classService.listByStaff(pagination, queryClassDto)\r\n  }\r\n\r\n  @ApiOperation({\r\n    summary: `[${UserRole.STAFF}] View Class Detail`\r\n  })\r\n  @ApiOkResponse({ type: StaffViewClassDetailDataResponse })\r\n  @ApiErrorResponse([Errors.CLASS_NOT_FOUND])\r\n  @Roles(UserRole.STAFF)\r\n  @Get(':id([0-9a-f]{24})')\r\n  async getDetail(@Param('id') classId: string) {\r\n    const [courseClass, learnerClass] = await Promise.all([\r\n      this.classService.findById(classId, CLASS_DETAIL_PROJECTION, [\r\n        {\r\n          path: 'garden',\r\n          select: ['name']\r\n        },\r\n        {\r\n          path: 'instructor',\r\n          select: ['name']\r\n        },\r\n        {\r\n          path: 'course',\r\n          select: ['code']\r\n        }\r\n      ]),\r\n      this.learnerClassService.findMany({ classId: new Types.ObjectId(classId) }, undefined, [{ path: 'learner' }])\r\n    ])\r\n\r\n    if (!courseClass) throw new AppException(Errors.CLASS_NOT_FOUND)\r\n    return { ...courseClass.toJSON(), learners: learnerClass?.map((learnerClass) => learnerClass?.['learner']) }\r\n  }\r\n\r\n  @ApiOperation({\r\n    summary: `[${UserRole.STAFF}] View Session Detail`\r\n  })\r\n  @ApiOkResponse({ type: ViewSessionDetailDataResponse })\r\n  @ApiErrorResponse([Errors.SESSION_NOT_FOUND])\r\n  @Roles(UserRole.STAFF)\r\n  @Get(':classId([0-9a-f]{24})/sessions/:sessionId([0-9a-f]{24})')\r\n  async getLessonDetail(@Param('classId') classId: string, @Param('sessionId') sessionId: string) {\r\n    const session = await this.sessionService.findOneBy({ sessionId, classId })\r\n\r\n    if (!session) throw new AppException(Errors.SESSION_NOT_FOUND)\r\n    return session\r\n  }\r\n\r\n  @ApiOperation({\r\n    summary: `[${UserRole.STAFF}] View Assignment Detail`\r\n  })\r\n  @ApiOkResponse({ type: ViewAssignmentDetailDataResponse })\r\n  @ApiErrorResponse([Errors.ASSIGNMENT_NOT_FOUND])\r\n  @Roles(UserRole.STAFF)\r\n  @Get(':classId([0-9a-f]{24})/assignments/:assignmentId([0-9a-f]{24})')\r\n  async getAssignmentDetail(@Param('classId') classId: string, @Param('assignmentId') assignmentId: string) {\r\n    const assignment = await this.assignmentService.findOneBy({ assignmentId, classId })\r\n\r\n    if (!assignment) throw new AppException(Errors.ASSIGNMENT_NOT_FOUND)\r\n    return assignment\r\n  }\r\n\r\n  @ApiOperation({\r\n    summary: `[${UserRole.GARDEN_MANAGER}] View Class Toolkit Requirements `\r\n  })\r\n  @ApiOkResponse({ type: GardenManagerViewClassDetailDataResponse })\r\n  @ApiErrorResponse([Errors.CLASS_NOT_FOUND])\r\n  @Roles(UserRole.GARDEN_MANAGER)\r\n  @Get(':id([0-9a-f]{24})/gardenRequiredToolkits')\r\n  async getClassToolkitRequirements(@Param('id') classId: string) {\r\n    const courseClass = await this.classService.findById(classId, GARDEN_MANAGER_VIEW_CLASS_DETAIL_PROJECTION, [\r\n      {\r\n        path: 'instructor',\r\n        select: ['name']\r\n      },\r\n      {\r\n        path: 'course',\r\n        select: ['code']\r\n      }\r\n    ])\r\n    if (!courseClass) throw new AppException(Errors.CLASS_NOT_FOUND)\r\n\r\n    return courseClass\r\n  }\r\n\r\n  @ApiOperation({\r\n    summary: `[${UserRole.STAFF}] Complete Class`\r\n  })\r\n  @ApiOkResponse({ type: SuccessDataResponse })\r\n  @ApiErrorResponse([Errors.CLASS_NOT_FOUND, Errors.CLASS_STATUS_INVALID, Errors.CLASS_END_TIME_INVALID])\r\n  @Roles(UserRole.STAFF)\r\n  @Patch(':id([0-9a-f]{24})/complete')\r\n  async completeClass(@Req() req, @Param('id') classId: string) {\r\n    const courseClass = await this.classService.findById(classId, CLASS_DETAIL_PROJECTION)\r\n    if (!courseClass) throw new AppException(Errors.CLASS_NOT_FOUND)\r\n\r\n    // check valid status\r\n    if (courseClass.status !== ClassStatus.IN_PROGRESS) throw new AppException(Errors.CLASS_STATUS_INVALID)\r\n\r\n    // check valid classEndDate\r\n    const { startDate, duration, weekdays, slotNumbers } = courseClass\r\n    const classEndTime = this.classService.getClassEndTime({ startDate, duration, weekdays, slotNumbers })\r\n    if (moment().tz(VN_TIMEZONE).isBefore(classEndTime)) throw new AppException(Errors.CLASS_END_TIME_INVALID)\r\n\r\n    const user = _.get(req, 'user')\r\n    await this.classService.completeClass(classId, user)\r\n    return new SuccessResponse(true)\r\n  }\r\n\r\n  @ApiOperation({\r\n    summary: `[${UserRole.STAFF}] Cancel Class`\r\n  })\r\n  @ApiOkResponse({ type: SuccessDataResponse })\r\n  @ApiErrorResponse([Errors.CLASS_NOT_FOUND, Errors.CLASS_STATUS_INVALID])\r\n  @Roles(UserRole.STAFF)\r\n  @Patch(':id([0-9a-f]{24})/cancel')\r\n  async cancelClass(@Req() req, @Param('id') classId: string, @Body() cancelClassDto: CancelClassDto) {\r\n    const courseClass = await this.classService.findById(classId, CLASS_DETAIL_PROJECTION)\r\n    if (!courseClass) throw new AppException(Errors.CLASS_NOT_FOUND)\r\n\r\n    // check valid status\r\n    if ([ClassStatus.PUBLISHED, ClassStatus.IN_PROGRESS].includes(courseClass.status) === false)\r\n      throw new AppException(Errors.CLASS_STATUS_INVALID)\r\n\r\n    const user = _.get(req, 'user')\r\n    await this.classService.cancelClass(classId, cancelClassDto, user)\r\n    return new SuccessResponse(true)\r\n  }\r\n}\r\n"]}
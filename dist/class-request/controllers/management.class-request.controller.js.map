{"version":3,"file":"management.class-request.controller.js","sourceRoot":"/","sources":["class-request/controllers/management.class-request.controller.ts"],"names":[],"mappings":"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","sourcesContent":["import { Controller, Get, UseGuards, Inject, Query, Param, Patch, Req, Body } from '@nestjs/common'\r\nimport { ApiBadRequestResponse, ApiBearerAuth, ApiOkResponse, ApiOperation, ApiQuery, ApiTags } from '@nestjs/swagger'\r\nimport * as _ from 'lodash'\r\n\r\nimport { ErrorResponse, PaginationQuery, SuccessDataResponse } from '@common/contracts/dto'\r\nimport { Roles } from '@auth/decorators/roles.decorator'\r\nimport { UserRole } from '@common/contracts/constant'\r\nimport { JwtAuthGuard } from '@auth/guards/jwt-auth.guard'\r\nimport { RolesGuard } from '@auth/guards/roles.guard'\r\nimport { AppException } from '@common/exceptions/app.exception'\r\nimport { Errors } from '@common/contracts/error'\r\nimport { ApiErrorResponse } from '@common/decorators/api-response.decorator'\r\nimport { IClassRequestService } from '@class-request/services/class-request.service'\r\nimport { Pagination, PaginationParams } from '@common/decorators/pagination.decorator'\r\nimport {\r\n  QueryClassRequestDto,\r\n  StaffViewClassRequestDetailDataResponse,\r\n  StaffViewClassRequestListDataResponse\r\n} from '@class-request/dto/view-class-request.dto'\r\nimport { CLASS_REQUEST_DETAIL_PROJECTION, CLASS_REQUEST_LIST_PROJECTION } from '@class-request/contracts/constant'\r\nimport { RejectClassRequestDto } from '@class-request/dto/reject-class-request.dto'\r\nimport { ApproveClassRequestDto } from '@class-request/dto/approve-class-request.dto'\r\n\r\n@ApiTags('ClassRequest - Management')\r\n@ApiBearerAuth()\r\n@ApiBadRequestResponse({ type: ErrorResponse })\r\n@UseGuards(JwtAuthGuard.ACCESS_TOKEN, RolesGuard)\r\n@Controller('management')\r\nexport class ManagementClassRequestController {\r\n  constructor(\r\n    @Inject(IClassRequestService)\r\n    private readonly classRequestService: IClassRequestService\r\n  ) {}\r\n\r\n  @ApiOperation({\r\n    summary: `[${UserRole.STAFF}] View Class Request List`\r\n  })\r\n  @ApiQuery({ type: PaginationQuery })\r\n  @ApiOkResponse({ type: StaffViewClassRequestListDataResponse })\r\n  @Roles(UserRole.STAFF)\r\n  @Get()\r\n  async list(@Pagination() pagination: PaginationParams, @Query() queryClassRequestDto: QueryClassRequestDto) {\r\n    return await this.classRequestService.list(pagination, queryClassRequestDto, CLASS_REQUEST_LIST_PROJECTION, [\r\n      {\r\n        path: 'createdBy',\r\n        select: ['_id', 'name', 'email', 'idCardPhoto', 'avatar']\r\n      }\r\n    ])\r\n  }\r\n\r\n  @ApiOperation({\r\n    summary: `[${UserRole.STAFF}] View Class Request Detail`\r\n  })\r\n  @ApiOkResponse({ type: StaffViewClassRequestDetailDataResponse })\r\n  @ApiErrorResponse([Errors.CLASS_REQUEST_NOT_FOUND])\r\n  @Roles(UserRole.STAFF)\r\n  @Get(':id([0-9a-f]{24})')\r\n  async getDetail(@Param('id') classRequestId: string) {\r\n    const classRequest = await this.classRequestService.findById(classRequestId, CLASS_REQUEST_DETAIL_PROJECTION, [\r\n      {\r\n        path: 'createdBy',\r\n        select: ['_id', 'name', 'phone', 'email', 'idCardPhoto', 'avatar']\r\n      },\r\n      {\r\n        path: 'class',\r\n        select: ['+sessions'],\r\n        populate: [\r\n          {\r\n            path: 'course',\r\n            select: ['code']\r\n          }\r\n        ]\r\n      }\r\n    ])\r\n\r\n    if (!classRequest) throw new AppException(Errors.CLASS_REQUEST_NOT_FOUND)\r\n    return classRequest\r\n  }\r\n\r\n  @ApiOperation({\r\n    summary: `[${UserRole.STAFF}] Approve Publish/Cancel Class Request`\r\n  })\r\n  @ApiOkResponse({ type: SuccessDataResponse })\r\n  @ApiErrorResponse([\r\n    Errors.CLASS_REQUEST_NOT_FOUND,\r\n    Errors.CLASS_REQUEST_STATUS_INVALID,\r\n    Errors.COURSE_NOT_FOUND,\r\n    Errors.COURSE_STATUS_INVALID,\r\n    Errors.CLASS_STATUS_INVALID,\r\n    Errors.GARDEN_NOT_AVAILABLE_FOR_CLASS_REQUEST,\r\n    Errors.CANCEL_CLASS_REQUEST_CAN_NOT_BE_APPROVED\r\n  ])\r\n  @Roles(UserRole.STAFF)\r\n  @Patch(':id([0-9a-f]{24})/approve')\r\n  async approve(\r\n    @Req() req,\r\n    @Param('id') classRequestId: string,\r\n    @Body() approveClassRequestDto: ApproveClassRequestDto\r\n  ) {\r\n    const user = _.get(req, 'user')\r\n    return this.classRequestService.approveClassRequest(classRequestId, approveClassRequestDto, user)\r\n  }\r\n\r\n  @ApiOperation({\r\n    summary: `[${UserRole.STAFF}] Reject Publish/Cancel Class Request`\r\n  })\r\n  @ApiOkResponse({ type: SuccessDataResponse })\r\n  @ApiErrorResponse([\r\n    Errors.CLASS_REQUEST_NOT_FOUND,\r\n    Errors.CLASS_REQUEST_STATUS_INVALID,\r\n    Errors.COURSE_NOT_FOUND,\r\n    Errors.COURSE_STATUS_INVALID,\r\n    Errors.CLASS_NOT_FOUND\r\n  ])\r\n  @Roles(UserRole.STAFF)\r\n  @Patch(':id([0-9a-f]{24})/reject')\r\n  async reject(@Req() req, @Param('id') classRequestId: string, @Body() RejectClassRequestDto: RejectClassRequestDto) {\r\n    const user = _.get(req, 'user')\r\n    return this.classRequestService.rejectClassRequest(classRequestId, RejectClassRequestDto, user)\r\n  }\r\n}\r\n"]}